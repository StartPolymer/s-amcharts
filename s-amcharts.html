<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="s-amcharts-script.html">
<link rel="import" href="s-amcharts-serial-script.html">
<link rel="import" href="s-amcharts-export-plugin-script.html">
<link rel="import" href="s-amcharts-export-plugin-style.html">
<link rel="import" href="s-amcharts-responsive-plugin-script.html">
<link rel="import" href="s-amcharts-cs-lang-script.html">
<link rel="import" href="s-amcharts-black-theme-script.html">

<!--
`s-amcharts`
A Web Component for high quality charts using amCharts lib.

@demo demo/index.html
-->

<dom-module id="s-amcharts">
<template>

<style include="s-amcharts-export-plugin-style">

:host {
  display: block;
  width: 100%;
  height: 500px;
  @apply --s-amcharts;
}

:host(:hover) .amcharts-export-menu {
  @apply --s-amcharts-hover-export-menu;
}

#chart {
  width: 100%;
  height: 100%;
  @apply --s-amcharts-chart;
}

.amcharts-export-menu {
  @apply --s-amcharts-export-menu;
}

.amcharts-export-menu:hover {
  @apply --s-amcharts-export-menu-hover;
}

.amcharts-export-menu .export-main > a {
  @apply --s-amcharts-export-menu-main-button;
}

.amcharts-export-menu li > a {
  @apply --s-amcharts-export-menu-button;
}

.amcharts-export-menu li:hover > a,
.amcharts-export-menu li.active > a {
  @apply --s-amcharts-export-menu-button-hover;
}

.amcharts-chart-div > a {
  @apply --s-amcharts-link;
}

</style>

<div id="chart"></div>
<div id="exportButton"></div>

</template>
<script>

Polymer({

  is: 's-amcharts',

  properties: {
    /**
     * JSON object with chart properties defined.
     */
    config: {
      type: Object,
      value: function() { return {}; }
    },

    data: {
      type: Array,
      value: function() { return []; }
    },

    /**
     * Delay in milliseconds to delay the initiation of the chart.
     */
    delay: {
      type: Number,
      value: 0
    },

    /**
     * Chart instance of AmChart.
     */
    chart: {
      notify: true
    },

    lang: {
      type: String,
      value: 'en',
      observer: '_langChanged'
    },

    /**
     * Specifies absolute or relative path to amCharts files, i.e. "amcharts/". (where all .js files are located)
     */
    path: {
      type: String,
      value: ''
    },

    plugins: {
      type: Array,
      value: function() { return []; }
    },

    theme: {
      type: String,
      value: 'light'
    },

    type: {
      type: String,
      value: 'serial'
    }
  },

  observers: [
    '_configDataChanged(config, data, isAttached)',
    '_dataSplicesChanged(data, data.splices)'
  ],

  // This is a public method the user can call if they've
  // changed our dimensions with CSS.
  resize: function() {
    if (this.chart) {
      this.chart.invalidateSize();
    }
  },

  setStyle: function(query, style) {
    var element = this.$$(query);
    element.style.cssText = element.style.cssText + style;
  },

  updateChart: function() {
    if (this.chart) {
      this.chart.dataProvider = this.data;
      this.chart.validateData();
    } else {
      this.config.dataProvider = this.data;
      this.config.language = this.lang;
      this.config.path = this.path || this.resolveUrl('../amcharts3/amcharts/');
      this.config.theme = this.theme;
      this.config.type = this.type;
      if (this.config.export) {
        this.config.export.divId = this.$.exportButton;
      }
      this.chart = AmCharts.makeChart(this.$.chart, this.config, this.delay);
    }
  },

  _configDataChanged: function(config, data, isAttached) {
    if (isAttached && Object.keys(config).length !== 0 && data.length !== 0) {
      this.updateChart();
    }
  },

  _dataSplicesChanged: function(data, dataSplices) {
    if (this.chart) {
      this.chart.dataProvider = data;
      this.chart.validateData();
    }
  },

  _langChanged: function(lang) {
    if (this.chart) {
      this.chart.language = lang;
      this.chart.validateNow();
    }
  }

});

</script>
</dom-module>
